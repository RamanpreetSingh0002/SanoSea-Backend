const Role = require("../models/role.js");
const User = require("../models/user.js");
const SubAdmin = require("../models/subAdmin.js");

const { sendError, generatePassword } = require("../utils/helper.js");
const { generateMailTransporter } = require("../utils/mail.js");

exports.create = async (req, res) => {
  const { firstName, lastName, email, phoneNumber, roleName, subAdminRole } =
    req.body;

  try {
    // Check if the email already exists
    const oldUserEmail = await User.findOne({ email });
    if (oldUserEmail) return sendError(res, "This email is already in use!");

    // Check if the phone number already exists
    const oldUserPhone = await User.findOne({ phoneNumber });
    if (oldUserPhone)
      return sendError(res, "This phone number is already in use!");

    // Fetch the roleId based on the provided role name
    const role = await Role.findOne({ name: roleName });
    if (!role) return sendError(res, "Invalid role name provided!");

    // Generate a secure password automatically
    const autoGeneratedPassword = generatePassword();

    // Create a new user and save
    const newUser = await User.create({
      fullName: lastName ? `${firstName} ${lastName}` : firstName,
      firstName,
      lastName,
      email,
      phoneNumber,
      password: autoGeneratedPassword,
      roleId: role._id,
    });

    // If the role is Coordinator or Audit Manager, store subAdminRole in SubAdmin schema
    if (roleName === "Coordinator" || roleName === "Audit Manager") {
      if (!subAdminRole) {
        return sendError(
          res,
          "SubAdmin role must be provided for this user!",
          400
        );
      }

      await SubAdmin.create({
        userId: newUser._id,
        subAdminRole,
      });
    }

    // Send email to the new user
    // const transport = mailTransporter();
    const transport = generateMailTransporter();

    transport.sendMail({
      from: "admin@sanosea.com",
      to: newUser.email,
      subject: "Welcome to SanoSea App - Your Account Credentials",
      html: `
          <h1>Welcome to SanoSea App</h1>
          <p>Your new account has been successfully created!</p>
          <p>Here are your login credentials:</p>
          <ul>
              <li><strong>Email:</strong> ${newUser.email}</li>
              <li><strong>Password:</strong> ${autoGeneratedPassword}</li>
          </ul>
          <p>For security reasons, we highly recommend you reset your password after logging in.</p>
          <p>Click <a href="http://localhost:3000/auth/change-password?email=${newUser.email}">here</a> to reset your password.</p>
          <p>Thank you for joining us!</p>
          <p>Best regards,</p>
          <p>SanoSea App Team</p>
        `,
    });

    res.status(201).json({
      user: {
        id: newUser._id,
        fullName: newUser.fullName,
        firstName: newUser.firstName,
        lastName: newUser.lastName,
        email: newUser.email,
        phoneNumber: newUser.phoneNumber,
        password: newUser.password,
        roleId: newUser.roleId,
        roleName: role.name,
        subAdminRole,
      },
      message:
        "Account Created Successfully! A temporary password has been sent to the user's email.",
    });
  } catch (error) {
    sendError(res, error.message, 500);
  }
};
